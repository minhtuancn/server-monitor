#!/bin/bash

###############################################################################
# Server Monitor Dashboard - Control Script
# Version: 2.0.0
# Description: Unified management interface for Server Monitor
# Usage: smctl [command] [options]
###############################################################################

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Configuration
INSTALL_DIR="/opt/server-monitor"
DATA_DIR="/var/lib/server-monitor"
BACKUP_DIR="$DATA_DIR/backups"

SERVICES=(
    "server-monitor-api"
    "server-monitor-ws"
    "server-monitor-terminal"
    "server-monitor-frontend"
)

###############################################################################
# Utility Functions
###############################################################################

print_usage() {
    cat << EOF
Server Monitor Dashboard Control Tool (smctl)

Usage: smctl [command] [options]

Commands:
    status          Show status of all services
    start           Start all services
    stop            Stop all services
    restart         Restart all services
    logs [service]  Show logs (tail -f) for all or specific service
    update          Update to latest version
    backup          Backup database
    restore <file>  Restore database from backup
    uninstall       Uninstall Server Monitor
    help            Show this help message

Examples:
    smctl status
    smctl restart
    smctl logs api
    smctl backup
    smctl update

EOF
}

check_root() {
    if [[ $EUID -ne 0 ]]; then
        echo -e "${RED}Error: This command requires root privileges${NC}"
        echo "Please run with sudo: sudo smctl $1"
        exit 1
    fi
}

###############################################################################
# Command Functions
###############################################################################

cmd_status() {
    echo -e "${CYAN}Server Monitor Service Status:${NC}"
    echo ""
    
    for service in "${SERVICES[@]}"; do
        if systemctl is-active --quiet "$service"; then
            status="${GREEN}● active${NC}"
        else
            status="${RED}● inactive${NC}"
        fi
        echo -e "  $service: $status"
    done
    
    echo ""
    echo -e "${CYAN}Ports:${NC}"
    for port in 9083 9081 9085 9084; do
        if lsof -Pi :$port -sTCP:LISTEN -t >/dev/null 2>&1; then
            echo -e "  Port $port: ${GREEN}listening${NC}"
        else
            echo -e "  Port $port: ${RED}not listening${NC}"
        fi
    done
    
    echo ""
    echo -e "${CYAN}Quick Access:${NC}"
    local ip=$(hostname -I | awk '{print $1}')
    echo -e "  Dashboard: ${GREEN}http://$ip:9081${NC}"
    echo -e "  API:       ${GREEN}http://$ip:9083${NC}"
}

cmd_start() {
    check_root "start"
    
    echo -e "${CYAN}Starting services...${NC}"
    for service in "${SERVICES[@]}"; do
        systemctl start "$service"
        echo -e "  ${GREEN}✓${NC} $service started"
    done
    echo -e "${GREEN}All services started${NC}"
}

cmd_stop() {
    check_root "stop"
    
    echo -e "${CYAN}Stopping services...${NC}"
    for service in "${SERVICES[@]}"; do
        systemctl stop "$service"
        echo -e "  ${GREEN}✓${NC} $service stopped"
    done
    echo -e "${GREEN}All services stopped${NC}"
}

cmd_restart() {
    check_root "restart"
    
    echo -e "${CYAN}Restarting services...${NC}"
    for service in "${SERVICES[@]}"; do
        systemctl restart "$service"
        echo -e "  ${GREEN}✓${NC} $service restarted"
    done
    echo -e "${GREEN}All services restarted${NC}"
}

cmd_logs() {
    local service_filter="$1"
    
    if [ -z "$service_filter" ]; then
        # Show all logs
        echo -e "${CYAN}Showing logs for all services (Ctrl+C to exit)...${NC}"
        journalctl -u 'server-monitor-*' -f
    else
        # Map short names to full service names
        case "$service_filter" in
            api)
                service="server-monitor-api"
                ;;
            ws|websocket)
                service="server-monitor-ws"
                ;;
            terminal|term)
                service="server-monitor-terminal"
                ;;
            frontend|web)
                service="server-monitor-frontend"
                ;;
            *)
                service="server-monitor-$service_filter"
                ;;
        esac
        
        echo -e "${CYAN}Showing logs for $service (Ctrl+C to exit)...${NC}"
        journalctl -u "$service" -f
    fi
}

cmd_update() {
    check_root "update"
    
    if [ ! -f "$INSTALL_DIR/scripts/update.sh" ]; then
        echo -e "${RED}Error: Update script not found${NC}"
        exit 1
    fi
    
    exec "$INSTALL_DIR/scripts/update.sh" "$@"
}

cmd_backup() {
    check_root "backup"
    
    echo -e "${CYAN}Backing up database...${NC}"
    
    if [ ! -f "$DATA_DIR/servers.db" ]; then
        echo -e "${RED}Error: Database not found${NC}"
        exit 1
    fi
    
    mkdir -p "$BACKUP_DIR"
    local timestamp=$(date +%Y%m%d-%H%M%S)
    local backup_file="$BACKUP_DIR/servers-$timestamp.db"
    
    cp "$DATA_DIR/servers.db" "$backup_file"
    
    echo -e "${GREEN}✓ Database backed up to: $backup_file${NC}"
    
    # Show backup list
    echo ""
    echo -e "${CYAN}Available backups:${NC}"
    ls -lh "$BACKUP_DIR"/servers-*.db | tail -5
}

cmd_restore() {
    check_root "restore"
    
    local backup_file="$1"
    
    if [ -z "$backup_file" ]; then
        echo -e "${RED}Error: Please specify backup file${NC}"
        echo "Usage: smctl restore <backup-file>"
        echo ""
        echo -e "${CYAN}Available backups:${NC}"
        ls -lh "$BACKUP_DIR"/servers-*.db 2>/dev/null || echo "  No backups found"
        exit 1
    fi
    
    if [ ! -f "$backup_file" ]; then
        echo -e "${RED}Error: Backup file not found: $backup_file${NC}"
        exit 1
    fi
    
    echo -e "${YELLOW}Warning: This will replace the current database${NC}"
    read -p "Continue? (yes/no): " -r
    if [[ ! $REPLY =~ ^[Yy][Ee][Ss]$ ]]; then
        echo "Restore cancelled"
        exit 0
    fi
    
    # Stop services
    echo -e "${CYAN}Stopping services...${NC}"
    systemctl stop server-monitor-api server-monitor-ws server-monitor-terminal
    
    # Restore
    cp "$backup_file" "$DATA_DIR/servers.db"
    chown server-monitor:server-monitor "$DATA_DIR/servers.db"
    
    # Start services
    echo -e "${CYAN}Starting services...${NC}"
    systemctl start server-monitor-api server-monitor-ws server-monitor-terminal
    
    echo -e "${GREEN}✓ Database restored from: $backup_file${NC}"
}

cmd_uninstall() {
    check_root "uninstall"
    
    echo -e "${RED}═══════════════════════════════════════════════════════${NC}"
    echo -e "${RED}           WARNING: UNINSTALL CONFIRMATION            ${NC}"
    echo -e "${RED}═══════════════════════════════════════════════════════${NC}"
    echo ""
    echo "This will:"
    echo "  - Stop and remove all services"
    echo "  - Delete installation directory: $INSTALL_DIR"
    echo "  - Keep data directory: $DATA_DIR (for backup)"
    echo "  - Keep config directory: /etc/server-monitor (for backup)"
    echo ""
    read -p "Type 'uninstall' to confirm: " -r
    
    if [[ "$REPLY" != "uninstall" ]]; then
        echo "Uninstall cancelled"
        exit 0
    fi
    
    echo ""
    echo -e "${CYAN}Uninstalling Server Monitor...${NC}"
    
    # Stop and disable services
    for service in "${SERVICES[@]}"; do
        systemctl stop "$service" 2>/dev/null || true
        systemctl disable "$service" 2>/dev/null || true
        rm -f "/etc/systemd/system/$service.service"
        echo -e "  ${GREEN}✓${NC} Removed $service"
    done
    
    systemctl daemon-reload
    
    # Remove installation directory
    if [ -d "$INSTALL_DIR" ]; then
        rm -rf "$INSTALL_DIR"
        echo -e "  ${GREEN}✓${NC} Removed $INSTALL_DIR"
    fi
    
    echo ""
    echo -e "${GREEN}Server Monitor uninstalled${NC}"
    echo ""
    echo -e "${CYAN}Preserved directories (manual cleanup if needed):${NC}"
    echo -e "  Data:   $DATA_DIR"
    echo -e "  Config: /etc/server-monitor"
    echo -e "  Logs:   /var/log/server-monitor"
    echo ""
    echo "To completely remove all data, run:"
    echo "  sudo rm -rf $DATA_DIR /etc/server-monitor /var/log/server-monitor"
}

###############################################################################
# Main Entry Point
###############################################################################

main() {
    if [ $# -eq 0 ]; then
        print_usage
        exit 0
    fi
    
    local command="$1"
    shift
    
    case "$command" in
        status)
            cmd_status
            ;;
        start)
            cmd_start
            ;;
        stop)
            cmd_stop
            ;;
        restart)
            cmd_restart
            ;;
        logs)
            cmd_logs "$@"
            ;;
        update)
            cmd_update "$@"
            ;;
        backup)
            cmd_backup
            ;;
        restore)
            cmd_restore "$@"
            ;;
        uninstall)
            cmd_uninstall
            ;;
        help|--help|-h)
            print_usage
            ;;
        *)
            echo -e "${RED}Error: Unknown command: $command${NC}"
            echo ""
            print_usage
            exit 1
            ;;
    esac
}

main "$@"
