name: "Security Scan"

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'frontend-next/**'
      - '.github/workflows/security-scan.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'frontend-next/**'
      - '.github/workflows/security-scan.yml'
  schedule:
    # Run weekly on Monday at 3 AM UTC
    - cron: '0 3 * * 1'
  workflow_dispatch:  # Allow manual trigger

# Cancel previous runs on same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# Restrict permissions for security
permissions:
  contents: read
  security-events: write

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '20'

jobs:
  python-security:
    name: Python Security Audit
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit bandit safety

      - name: Run pip-audit
        id: pip-audit
        continue-on-error: true
        run: |
          echo "## Python Dependency Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if pip-audit -r backend/requirements.txt --desc; then
            echo "âœ… No known vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Vulnerabilities found - please review and update dependencies" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Run Bandit SAST
        id: bandit
        continue-on-error: true
        run: |
          echo "## Bandit Static Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          bandit -r backend/ -f json -o bandit-report.json || true
          
          if [ -f bandit-report.json ]; then
            # Count issues by severity
            high=$(jq '[.results[] | select(.issue_severity=="HIGH")] | length' bandit-report.json)
            medium=$(jq '[.results[] | select(.issue_severity=="MEDIUM")] | length' bandit-report.json)
            low=$(jq '[.results[] | select(.issue_severity=="LOW")] | length' bandit-report.json)
            
            echo "- ðŸ”´ High: $high" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ¡ Medium: $medium" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ¢ Low: $low" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "$high" -gt 0 ]; then
              echo "âš ï¸ High severity issues found - please review" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… No high severity issues" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Run Safety check
        id: safety
        continue-on-error: true
        run: |
          echo "## Safety Dependency Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          pip install -r backend/requirements.txt
          if safety check --json > safety-report.json; then
            echo "âœ… No known security issues in dependencies" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Security issues found in dependencies" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-security-reports
          path: |
            bandit-report.json
            safety-report.json
          if-no-files-found: ignore
          retention-days: 30

  npm-audit:
    name: Node.js Security Audit
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend-next/package-lock.json

      - name: Run npm audit (Frontend)
        continue-on-error: true
        working-directory: ./frontend-next
        run: |
          echo "## Frontend npm audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          npm audit --json > ../npm-audit-frontend.json || true
          
          if [ -f ../npm-audit-frontend.json ]; then
            critical=$(jq '.metadata.vulnerabilities.critical // 0' ../npm-audit-frontend.json)
            high=$(jq '.metadata.vulnerabilities.high // 0' ../npm-audit-frontend.json)
            moderate=$(jq '.metadata.vulnerabilities.moderate // 0' ../npm-audit-frontend.json)
            low=$(jq '.metadata.vulnerabilities.low // 0' ../npm-audit-frontend.json)
            
            echo "- ðŸ”´ Critical: $critical" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ  High: $high" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ¡ Moderate: $moderate" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ¢ Low: $low" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "$critical" -gt 0 ] || [ "$high" -gt 0 ]; then
              echo "âš ï¸ Critical or high severity issues found" >> $GITHUB_STEP_SUMMARY
              echo "Run 'npm audit fix' to resolve" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… No critical or high severity issues" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Run npm audit (E2E Tests)
        continue-on-error: true
        working-directory: ./e2e-tests
        run: |
          if [ -f package.json ]; then
            echo "## E2E Tests npm audit" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            npm audit --json > ../npm-audit-e2e.json || true
            
            if [ -f ../npm-audit-e2e.json ]; then
              critical=$(jq '.metadata.vulnerabilities.critical // 0' ../npm-audit-e2e.json)
              high=$(jq '.metadata.vulnerabilities.high // 0' ../npm-audit-e2e.json)
              
              echo "- ðŸ”´ Critical: $critical" >> $GITHUB_STEP_SUMMARY
              echo "- ðŸŸ  High: $high" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              if [ "$critical" -eq 0 ] && [ "$high" -eq 0 ]; then
                echo "âœ… No critical or high severity issues" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          fi

      - name: Upload npm audit reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-reports
          path: |
            npm-audit-frontend.json
            npm-audit-e2e.json
          if-no-files-found: ignore
          retention-days: 30

  summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [python-security, npm-audit]
    if: always()
    permissions:
      contents: read

    steps:
      - name: Check results
        run: |
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Python Security: ${{ needs.python-security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- npm Audit: ${{ needs.npm-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ Security scans use continue-on-error to avoid blocking CI" >> $GITHUB_STEP_SUMMARY
          echo "Please review artifacts for detailed findings" >> $GITHUB_STEP_SUMMARY
