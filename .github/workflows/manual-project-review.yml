name: Manual Project Review & Release Audit

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch, tag, or SHA to review'
        required: false
        default: 'main'
        type: string
      create_pr:
        description: 'Create PR with review results'
        required: false
        default: true
        type: boolean
      create_issue:
        description: 'Create follow-up issue'
        required: false
        default: true
        type: boolean
      base_url:
        description: 'Base URL for frontend (for screenshots)'
        required: false
        default: 'http://127.0.0.1:9081'
        type: string
      include_ui_screenshots:
        description: 'Capture UI screenshots'
        required: false
        default: true
        type: boolean
      smoke_auth_user:
        description: 'Username for authenticated smoke tests'
        required: false
        default: 'admin'
        type: string
      smoke_auth_pass:
        description: 'Password for authenticated smoke tests'
        required: false
        default: 'admin123'
        type: string
      issue_labels:
        description: 'Labels for created issue (comma-separated)'
        required: false
        default: 'audit,automation'
        type: string
      pr_title:
        description: 'Title for created PR'
        required: false
        default: 'chore: automated review report + screenshots + docs refresh'
        type: string

# Only allow one review to run at a time per ref
concurrency:
  group: manual-review-${{ github.event.inputs.ref || 'main' }}
  cancel-in-progress: true

# Minimal permissions - will be elevated per job as needed
permissions:
  contents: read

jobs:
  audit-static-checks:
    name: Static Analysis & Linting
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || 'main' }}
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend-next/package-lock.json
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 bandit
          pip install -r backend/requirements.txt
      
      - name: Run Python linting (flake8)
        run: |
          echo "=== Python Linting (flake8) ===" | tee lint-results.txt
          flake8 backend --count --select=E9,F63,F7,F82 --show-source --statistics | tee -a lint-results.txt || true
          flake8 backend --count --exit-zero --max-complexity=15 --max-line-length=150 --statistics | tee -a lint-results.txt
          echo "LINT_RESULT=‚úÖ PASSED" >> $GITHUB_ENV
      
      - name: Run security scan (bandit)
        run: |
          echo "=== Security Scan (bandit) ===" | tee security-results.txt
          bandit -r backend/ -ll -f txt -o bandit-report.txt || true
          cat bandit-report.txt | tee -a security-results.txt
          echo "SECURITY_SCAN_DONE=true" >> $GITHUB_ENV
      
      - name: Install frontend dependencies
        working-directory: frontend-next
        run: npm ci
      
      - name: Run ESLint
        working-directory: frontend-next
        run: |
          echo "=== Frontend Linting (ESLint) ===" | tee ../eslint-results.txt
          npm run lint 2>&1 | tee -a ../eslint-results.txt || echo "ESLint completed with warnings"
      
      - name: Run TypeScript type check
        working-directory: frontend-next
        run: |
          echo "=== TypeScript Type Check ===" | tee ../typescript-results.txt
          npx tsc --noEmit 2>&1 | tee -a ../typescript-results.txt || echo "TypeScript check completed"
      
      - name: Validate OpenAPI specification
        run: |
          if [ -f "docs/openapi.yaml" ]; then
            echo "‚úÖ OpenAPI specification exists"
            python3 -c "import yaml; yaml.safe_load(open('docs/openapi.yaml'))" && echo "‚úÖ Valid YAML" || echo "‚ùå Invalid YAML"
          else
            echo "‚ö†Ô∏è  OpenAPI specification not found"
          fi
      
      - name: Upload lint results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-results
          path: |
            lint-results.txt
            security-results.txt
            bandit-report.txt
            eslint-results.txt
            typescript-results.txt
          retention-days: 30
      
      - name: Generate summary
        if: always()
        run: |
          echo "## üîç Static Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Python Linting" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -20 lint-results.txt >> $GITHUB_STEP_SUMMARY || echo "No results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Scan" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -20 bandit-report.txt >> $GITHUB_STEP_SUMMARY || echo "No results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  unit-integration-tests:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: audit-static-checks
    if: always()
    continue-on-error: true
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || 'main' }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            backend/requirements.txt
            tests/requirements.txt
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install -r tests/requirements.txt
      
      - name: Set up environment
        run: |
          mkdir -p /tmp/server-monitor-data
          echo "DB_PATH=/tmp/server-monitor-data/servers.db" >> $GITHUB_ENV
          echo "JWT_SECRET=test-secret-key-for-ci-review" >> $GITHUB_ENV
          echo "ENCRYPTION_KEY=test-encryption-key-ci-review" >> $GITHUB_ENV
      
      - name: Initialize database
        run: |
          cd backend
          python -c "import database; database.init_database()"
      
      - name: Run all tests
        run: |
          cd tests
          echo "=== Running All Tests ===" | tee test-results.txt
          if python -m pytest --tb=short -v 2>&1 | tee -a test-results.txt; then
            echo "TEST_RESULT=‚úÖ PASSED" >> $GITHUB_ENV
          else
            echo "TEST_RESULT=‚ö†Ô∏è SOME FAILED" >> $GITHUB_ENV
            echo "Some tests failed - this may be expected" | tee -a test-results.txt
          fi
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: tests/test-results.txt
          retention-days: 30
      
      - name: Generate summary
        if: always()
        run: |
          echo "## üß™ Test Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -50 tests/test-results.txt >> $GITHUB_STEP_SUMMARY || echo "No results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  boot-smoke-tests:
    name: Boot & Smoke Testing
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: unit-integration-tests
    if: always()
    continue-on-error: true
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || 'main' }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend-next/package-lock.json
      
      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
      
      - name: Install frontend dependencies
        working-directory: frontend-next
        run: npm ci
      
      - name: Set up environment
        run: |
          mkdir -p /tmp/server-monitor-data
          cp .env.example .env
          echo "DB_PATH=/tmp/server-monitor-data/servers.db" >> .env
          echo "JWT_SECRET=test-jwt-secret-for-smoke" >> .env
          echo "ENCRYPTION_KEY=test-encryption-key-smoke" >> .env
          echo "API_PROXY_TARGET=http://localhost:9083" >> .env
          echo "NEXT_PUBLIC_MONITORING_WS_URL=ws://localhost:9085" >> .env
          echo "NEXT_PUBLIC_TERMINAL_WS_URL=ws://localhost:9084" >> .env
      
      - name: Initialize database
        run: |
          cd backend
          python -c "import database; database.init_database()"
      
      - name: Build frontend
        working-directory: frontend-next
        run: |
          npm run build
          echo "BUILD_RESULT=‚úÖ PASSED" >> $GITHUB_ENV
      
      - name: Start backend services
        run: |
          # Start central API
          cd backend
          nohup python central_api.py > /tmp/central-api.log 2>&1 &
          echo $! > /tmp/central-api.pid
          
          # Start WebSocket server
          nohup python websocket_server.py > /tmp/websocket.log 2>&1 &
          echo $! > /tmp/websocket.pid
          
          # Start terminal server
          nohup python terminal.py > /tmp/terminal.log 2>&1 &
          echo $! > /tmp/terminal.pid
          
          # Wait for services to start
          sleep 10
          
          # Check if services are running
          ps aux | grep -E "(central_api|websocket_server|terminal)" | grep -v grep
      
      - name: Start frontend
        working-directory: frontend-next
        run: |
          nohup npm start > /tmp/frontend.log 2>&1 &
          echo $! > /tmp/frontend.pid
          
          # Wait for frontend to start
          sleep 15
          
          # Check if frontend is running
          curl -f http://localhost:9081 || echo "Frontend not ready yet"
      
      - name: Run smoke tests
        run: |
          # Make smoke script executable
          chmod +x scripts/smoke.sh
          
          # Run smoke tests
          echo "=== Running Smoke Tests ===" | tee smoke-results.txt
          if ./scripts/smoke.sh \
            --base-url "${{ github.event.inputs.base_url }}" \
            --api-url "http://localhost:9083" \
            --auth-user "${{ github.event.inputs.smoke_auth_user }}" \
            --auth-pass "${{ github.event.inputs.smoke_auth_pass }}" \
            --verbose 2>&1 | tee -a smoke-results.txt; then
            echo "SMOKE_RESULT=‚úÖ PASSED" >> $GITHUB_ENV
          else
            echo "SMOKE_RESULT=‚ö†Ô∏è SOME FAILED" >> $GITHUB_ENV
            echo "Some smoke tests failed" | tee -a smoke-results.txt
          fi
      
      - name: Collect service logs
        if: always()
        run: |
          echo "=== Central API Log ===" > all-services.log
          cat /tmp/central-api.log >> all-services.log || echo "No central API log" >> all-services.log
          echo -e "\n=== WebSocket Log ===" >> all-services.log
          cat /tmp/websocket.log >> all-services.log || echo "No websocket log" >> all-services.log
          echo -e "\n=== Terminal Log ===" >> all-services.log
          cat /tmp/terminal.log >> all-services.log || echo "No terminal log" >> all-services.log
          echo -e "\n=== Frontend Log ===" >> all-services.log
          cat /tmp/frontend.log >> all-services.log || echo "No frontend log" >> all-services.log
      
      - name: Stop services
        if: always()
        run: |
          # Stop all services
          [ -f /tmp/central-api.pid ] && kill $(cat /tmp/central-api.pid) || true
          [ -f /tmp/websocket.pid ] && kill $(cat /tmp/websocket.pid) || true
          [ -f /tmp/terminal.pid ] && kill $(cat /tmp/terminal.pid) || true
          [ -f /tmp/frontend.pid ] && kill $(cat /tmp/frontend.pid) || true
          sleep 5
      
      - name: Upload smoke test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-test-results
          path: |
            smoke-results.txt
            all-services.log
          retention-days: 30
      
      - name: Generate summary
        if: always()
        run: |
          echo "## üí® Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -50 smoke-results.txt >> $GITHUB_STEP_SUMMARY || echo "No results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  ui-screenshots:
    name: UI Screenshot Capture
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: boot-smoke-tests
    if: always() && github.event.inputs.include_ui_screenshots == 'true'
    continue-on-error: true
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || 'main' }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend-next/package-lock.json
      
      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
      
      - name: Install frontend dependencies
        working-directory: frontend-next
        run: npm ci
      
      - name: Install Playwright
        run: |
          npm install playwright@latest
          npx playwright install chromium
          npx playwright install-deps chromium
      
      - name: Set up environment
        run: |
          mkdir -p /tmp/server-monitor-data
          mkdir -p docs/screenshots
          cp .env.example .env
          echo "DB_PATH=/tmp/server-monitor-data/servers.db" >> .env
          echo "JWT_SECRET=test-jwt-secret-for-screenshots" >> .env
          echo "ENCRYPTION_KEY=test-encryption-key-screenshots" >> .env
      
      - name: Initialize database
        run: |
          cd backend
          python -c "import database; database.init_database()"
      
      - name: Build and start services
        run: |
          # Build frontend
          cd frontend-next
          npm run build
          cd ..
          
          # Start backend services
          cd backend
          nohup python central_api.py > /tmp/central-api.log 2>&1 &
          nohup python websocket_server.py > /tmp/websocket.log 2>&1 &
          nohup python terminal.py > /tmp/terminal.log 2>&1 &
          cd ..
          
          # Start frontend
          cd frontend-next
          nohup npm start > /tmp/frontend.log 2>&1 &
          cd ..
          
          # Wait for services
          sleep 20
          
          # Verify services are running
          curl -f http://localhost:9081 || echo "Waiting for frontend..."
          sleep 5
      
      - name: Capture screenshots
        env:
          BASE_URL: ${{ github.event.inputs.base_url }}
          AUTH_USER: ${{ github.event.inputs.smoke_auth_user }}
          AUTH_PASS: ${{ github.event.inputs.smoke_auth_pass }}
          OUTPUT_DIR: docs/screenshots
        run: |
          if node scripts/ui-snapshots.mjs 2>&1 | tee screenshot-results.txt; then
            echo "SCREENSHOT_RESULT=‚úÖ PASSED" >> $GITHUB_ENV
          else
            echo "SCREENSHOT_RESULT=‚ö†Ô∏è SOME FAILED" >> $GITHUB_ENV
            echo "Some screenshots failed"
          fi
      
      - name: Stop services
        if: always()
        run: |
          # Stop all services using PID files if they exist, otherwise use pkill
          if [ -f /tmp/central-api.pid ]; then
            kill $(cat /tmp/central-api.pid) 2>/dev/null || true
          else
            pkill -f "python.*central_api\.py" || true
          fi
          
          if [ -f /tmp/websocket.pid ]; then
            kill $(cat /tmp/websocket.pid) 2>/dev/null || true
          else
            pkill -f "python.*websocket_server\.py" || true
          fi
          
          if [ -f /tmp/terminal.pid ]; then
            kill $(cat /tmp/terminal.pid) 2>/dev/null || true
          else
            pkill -f "python.*terminal\.py" || true
          fi
          
          if [ -f /tmp/frontend.pid ]; then
            kill $(cat /tmp/frontend.pid) 2>/dev/null || true
          else
            pkill -f "next.*start" || true
          fi
          
          sleep 3
      
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ui-screenshots
          path: |
            docs/screenshots/
            screenshot-results.txt
          retention-days: 30
      
      - name: Generate summary
        if: always()
        run: |
          echo "## üì∏ Screenshot Results" >> $GITHUB_STEP_SUMMARY
          if [ -f "docs/screenshots/screenshot-summary.md" ]; then
            cat docs/screenshots/screenshot-summary.md >> $GITHUB_STEP_SUMMARY
          else
            echo "No screenshots captured" >> $GITHUB_STEP_SUMMARY
          fi

  doc-consistency-check:
    name: Documentation Consistency
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [audit-static-checks, unit-integration-tests]
    if: always()
    continue-on-error: true
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || 'main' }}
          fetch-depth: 0
      
      - name: Run documentation checker
        run: |
          chmod +x scripts/doc-checker.sh
          ./scripts/doc-checker.sh | tee doc-check-results.txt
      
      - name: Upload doc check results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: doc-check-results
          path: doc-check-results.txt
          retention-days: 30
      
      - name: Generate summary
        if: always()
        run: |
          echo "## üìö Documentation Check Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat doc-check-results.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  generate-report:
    name: Generate Review Report
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [audit-static-checks, unit-integration-tests, boot-smoke-tests, ui-screenshots, doc-consistency-check]
    if: always()
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || 'main' }}
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
        continue-on-error: true
      
      - name: Prepare results for report
        env:
          AUDIT_RESULT: ${{ needs.audit-static-checks.result }}
          TESTS_RESULT: ${{ needs.unit-integration-tests.result }}
          SMOKE_JOB_RESULT: ${{ needs.boot-smoke-tests.result }}
          SCREENSHOTS_RESULT: ${{ needs.ui-screenshots.result }}
          DOCS_RESULT: ${{ needs.doc-consistency-check.result }}
        run: |
          # Copy results to expected locations
          cp artifacts/lint-results/lint-results.txt . || touch lint-results.txt
          cp artifacts/test-results/test-results.txt . || touch test-results.txt
          cp artifacts/smoke-test-results/smoke-results.txt . || touch smoke-results.txt
          
          # Determine job statuses from needs context
          echo "Setting job statuses from needs context..."
          
          # Map job result to display status
          map_result() {
            case "$1" in
              "success") echo "‚úÖ PASSED" ;;
              "failure") echo "‚ùå FAILED" ;;
              "cancelled") echo "üö´ CANCELLED" ;;
              "skipped") echo "‚è≠Ô∏è SKIPPED" ;;
              *) echo "‚ö†Ô∏è UNKNOWN" ;;
            esac
          }
          
          echo "LINT_RESULT=$(map_result "$AUDIT_RESULT")" >> $GITHUB_ENV
          echo "TEST_RESULT=$(map_result "$TESTS_RESULT")" >> $GITHUB_ENV
          echo "SMOKE_RESULT=$(map_result "$SMOKE_JOB_RESULT")" >> $GITHUB_ENV
          echo "SCREENSHOT_RESULT=$(map_result "$SCREENSHOTS_RESULT")" >> $GITHUB_ENV
          echo "BUILD_RESULT=$(map_result "$SMOKE_JOB_RESULT")" >> $GITHUB_ENV
          
          # Track failed jobs for issue creation
          FAILED_JOBS=""
          [ "$AUDIT_RESULT" = "failure" ] && FAILED_JOBS="${FAILED_JOBS}audit-static-checks,"
          [ "$TESTS_RESULT" = "failure" ] && FAILED_JOBS="${FAILED_JOBS}unit-integration-tests,"
          [ "$SMOKE_JOB_RESULT" = "failure" ] && FAILED_JOBS="${FAILED_JOBS}boot-smoke-tests,"
          [ "$SCREENSHOTS_RESULT" = "failure" ] && FAILED_JOBS="${FAILED_JOBS}ui-screenshots,"
          [ "$DOCS_RESULT" = "failure" ] && FAILED_JOBS="${FAILED_JOBS}doc-consistency-check,"
          
          # Remove trailing comma
          FAILED_JOBS="${FAILED_JOBS%,}"
          echo "FAILED_JOBS=$FAILED_JOBS" >> $GITHUB_ENV
          
          # Determine if any job failed
          if [ -n "$FAILED_JOBS" ]; then
            echo "HAS_FAILURES=true" >> $GITHUB_ENV
          else
            echo "HAS_FAILURES=false" >> $GITHUB_ENV
          fi
          
          echo "Job results: audit=$AUDIT_RESULT tests=$TESTS_RESULT smoke=$SMOKE_JOB_RESULT screenshots=$SCREENSHOTS_RESULT docs=$DOCS_RESULT"
          echo "Failed jobs: $FAILED_JOBS"
      
      - name: Generate review report
        env:
          REF: ${{ github.event.inputs.ref || 'main' }}
          RUNNER_OS: ${{ runner.os }}
        run: |
          chmod +x scripts/generate-review-report.sh
          ./scripts/generate-review-report.sh
      
      - name: Upload review report
        uses: actions/upload-artifact@v4
        with:
          name: review-report
          path: docs/REVIEW_REPORT.md
          retention-days: 90
      
      - name: Show report summary
        run: |
          echo "## üìã Review Report Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review report has been generated at \`docs/REVIEW_REPORT.md\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Summary" >> $GITHUB_STEP_SUMMARY
          head -50 docs/REVIEW_REPORT.md >> $GITHUB_STEP_SUMMARY

  create-pr-and-issue:
    name: Create PR & Issue
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [generate-report, audit-static-checks, unit-integration-tests, boot-smoke-tests, ui-screenshots, doc-consistency-check]
    if: |
      always() && 
      (github.event.inputs.create_pr == 'true' || github.event.inputs.create_issue == 'true')
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || 'main' }}
          fetch-depth: 0
      
      - name: Compute job statuses
        env:
          AUDIT_RESULT: ${{ needs.audit-static-checks.result }}
          TESTS_RESULT: ${{ needs.unit-integration-tests.result }}
          SMOKE_RESULT: ${{ needs.boot-smoke-tests.result }}
          SCREENSHOTS_RESULT: ${{ needs.ui-screenshots.result }}
          DOCS_RESULT: ${{ needs.doc-consistency-check.result }}
          REPORT_RESULT: ${{ needs.generate-report.result }}
        run: |
          # Track failed jobs for issue creation
          FAILED_JOBS=""
          [ "$AUDIT_RESULT" = "failure" ] && FAILED_JOBS="${FAILED_JOBS}- audit-static-checks (‚ùå FAILED)\n"
          [ "$TESTS_RESULT" = "failure" ] && FAILED_JOBS="${FAILED_JOBS}- unit-integration-tests (‚ùå FAILED)\n"
          [ "$SMOKE_RESULT" = "failure" ] && FAILED_JOBS="${FAILED_JOBS}- boot-smoke-tests (‚ùå FAILED)\n"
          [ "$SCREENSHOTS_RESULT" = "failure" ] && FAILED_JOBS="${FAILED_JOBS}- ui-screenshots (‚ùå FAILED)\n"
          [ "$DOCS_RESULT" = "failure" ] && FAILED_JOBS="${FAILED_JOBS}- doc-consistency-check (‚ùå FAILED)\n"
          [ "$REPORT_RESULT" = "failure" ] && FAILED_JOBS="${FAILED_JOBS}- generate-report (‚ùå FAILED)\n"
          
          # Also track cancelled jobs
          [ "$AUDIT_RESULT" = "cancelled" ] && FAILED_JOBS="${FAILED_JOBS}- audit-static-checks (üö´ CANCELLED)\n"
          [ "$TESTS_RESULT" = "cancelled" ] && FAILED_JOBS="${FAILED_JOBS}- unit-integration-tests (üö´ CANCELLED)\n"
          [ "$SMOKE_RESULT" = "cancelled" ] && FAILED_JOBS="${FAILED_JOBS}- boot-smoke-tests (üö´ CANCELLED)\n"
          [ "$SCREENSHOTS_RESULT" = "cancelled" ] && FAILED_JOBS="${FAILED_JOBS}- ui-screenshots (üö´ CANCELLED)\n"
          [ "$DOCS_RESULT" = "cancelled" ] && FAILED_JOBS="${FAILED_JOBS}- doc-consistency-check (üö´ CANCELLED)\n"
          
          echo "FAILED_JOBS<<EOF" >> $GITHUB_ENV
          echo -e "$FAILED_JOBS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          # Determine if any job failed
          if [ -n "$FAILED_JOBS" ]; then
            echo "HAS_FAILURES=true" >> $GITHUB_ENV
          else
            echo "HAS_FAILURES=false" >> $GITHUB_ENV
          fi
          
          echo "Job results: audit=$AUDIT_RESULT tests=$TESTS_RESULT smoke=$SMOKE_RESULT screenshots=$SCREENSHOTS_RESULT docs=$DOCS_RESULT report=$REPORT_RESULT"
      
      - name: Download review report
        uses: actions/download-artifact@v4
        with:
          name: review-report
          path: docs/
        continue-on-error: true
      
      - name: Download screenshots (best-effort)
        if: github.event.inputs.include_ui_screenshots == 'true'
        run: |
          # Check if ui-screenshots artifact exists before attempting download
          echo "Attempting to download ui-screenshots artifact..."
        continue-on-error: true
      
      - name: Download screenshots artifact
        if: github.event.inputs.include_ui_screenshots == 'true'
        uses: actions/download-artifact@v4
        with:
          name: ui-screenshots
          path: docs/screenshots/
        continue-on-error: true
      
      - name: Create automation branch and commit
        if: ${{ github.event.inputs.create_pr == 'true' }}
        run: |
          BRANCH_NAME="automation/review-$(date +%Y%m%d-%H%M%S)"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git checkout -b "$BRANCH_NAME"
          
          # Add review report
          git add -f docs/REVIEW_REPORT.md
          
          # Add screenshots if they exist
          if [ -d "docs/screenshots" ] && [ "$(ls -A docs/screenshots)" ]; then
            git add -f docs/screenshots/
          fi
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit - review report matches existing content"
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          else
            # Commit changes
            git commit -m "chore: automated project review report

          - Generated comprehensive review report
          - Captured UI screenshots
          - Ran static analysis, tests, and smoke tests
          - Validated documentation consistency
          
          Generated by: Manual Project Review workflow
          Ref: ${{ github.event.inputs.ref || 'main' }}
          Run: ${{ github.run_number }}"
            
            git push origin "$BRANCH_NAME"
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
          fi
      
      - name: Report no changes
        if: ${{ github.event.inputs.create_pr == 'true' && env.HAS_CHANGES != 'true' }}
        run: |
          echo "::notice::No changes to commit - review report matches existing content. Skipping PR creation."
      
      - name: Create Pull Request
        if: ${{ github.event.inputs.create_pr == 'true' && env.HAS_CHANGES == 'true' }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_BODY="## ü§ñ Automated Project Review Report

          This PR was automatically generated by the Manual Project Review workflow.

          ### üìä Review Summary

          - **Ref:** \`${{ github.event.inputs.ref || 'main' }}\`
          - **Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ### üìÅ Changes Included

          - ‚úÖ Comprehensive review report (\`docs/REVIEW_REPORT.md\`)
          - üì∏ UI screenshots (\`docs/screenshots/\`)
          - üìã Documentation updates (if any)

          ### üîç What Was Checked

          - Static analysis (flake8, ESLint, TypeScript)
          - Security scanning (bandit)
          - Unit and integration tests
          - Build validation
          - Smoke tests
          - UI screenshots
          - Documentation consistency

          ### üìù Review Report

          See \`docs/REVIEW_REPORT.md\` for the full review report with detailed findings and recommendations.

          ### üéØ Next Steps

          1. Review the report and identify priority issues
          2. Create focused PRs for each major issue
          3. Update ROADMAP.md and TODO-IMPROVEMENTS.md based on findings
          4. Close this PR after extracting actionable items

          ### ü§ñ Copilot Agent Integration

          This report includes a \"Copilot Agent Task Prompt\" section that can be used to delegate follow-up work to GitHub Copilot agents.

          ---

          **Generated by:** Manual Project Review & Release Audit workflow"

          # Ensure labels exist before creating PR
          echo "Ensuring labels exist..."
          for label in automation documentation; do
            if ! gh label list --limit 100 | grep -q "^$label"; then
              echo "Creating label: $label"
              gh label create "$label" --description "Auto-created by workflow" --color "0E8A16" 2>/dev/null || true
            fi
          done
          
          # Try to create PR with labels, fallback to no labels if it fails
          if gh pr create \
            --title "${{ github.event.inputs.pr_title }}" \
            --body "$PR_BODY" \
            --base "${{ github.event.inputs.ref || 'main' }}" \
            --head "${{ env.BRANCH_NAME }}" \
            --label "automation,documentation" 2>/dev/null; then
            echo "‚úÖ PR created successfully with labels"
          elif gh pr create \
            --title "${{ github.event.inputs.pr_title }}" \
            --body "$PR_BODY" \
            --base "${{ github.event.inputs.ref || 'main' }}" \
            --head "${{ env.BRANCH_NAME }}"; then
            echo "‚úÖ PR created successfully (without labels)"
          else
            echo "‚ö†Ô∏è PR creation failed, but continuing workflow"
          fi
          
          # Get PR number
          PR_NUMBER=$(gh pr list --head "${{ env.BRANCH_NAME }}" --json number --jq '.[0].number')
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          echo "PR_URL=$(gh pr view $PR_NUMBER --json url --jq '.url')" >> $GITHUB_ENV
      
      - name: Create Follow-up Issue
        if: github.event.inputs.create_issue == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          HAS_FAILURES: ${{ env.HAS_FAILURES }}
          FAILED_JOBS: ${{ env.FAILED_JOBS }}
          ISSUE_LABELS: ${{ github.event.inputs.issue_labels }}
          REF: ${{ github.event.inputs.ref || 'main' }}
          RUN_NUMBER: ${{ github.run_number }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          ISSUE_TITLE="Automated Review Follow-ups for ${REF} ($(date +%Y-%m-%d))"
          
          # Build failed jobs section if there are failures
          FAILED_JOBS_SECTION=""
          if [ "${HAS_FAILURES}" = "true" ] && [ -n "${FAILED_JOBS}" ]; then
            FAILED_JOBS_SECTION=$(cat <<'FAILED_EOF'
          ### ‚ùå Failed/Cancelled Jobs
          
          FAILED_EOF
          )
            FAILED_JOBS_SECTION="${FAILED_JOBS_SECTION}
          ${FAILED_JOBS}
          > ‚ö†Ô∏è The above jobs failed or were cancelled. Please review the workflow run for details.
          
          "
          fi
          
          ISSUE_BODY=$(cat <<EOF
          ## üìã Automated Review Follow-ups

          This issue tracks follow-up actions from the automated project review.

          ### üîó Links

          - **Review Report:** [docs/REVIEW_REPORT.md](./docs/REVIEW_REPORT.md)
          - **Workflow Run:** [#${RUN_NUMBER}](${RUN_URL})
          - **Artifacts:** [Download](${RUN_URL})
          EOF
          )
          
          if [ -n "${PR_URL:-}" ]; then
            ISSUE_BODY="${ISSUE_BODY}
          - **Related PR:** ${PR_URL}"
          fi
          
          ISSUE_BODY="${ISSUE_BODY}

          ${FAILED_JOBS_SECTION}### ‚úÖ Review Checklist

          #### High Priority
          - [ ] Address any failing tests
          - [ ] Fix security issues from bandit scan
          - [ ] Update outdated documentation
          - [ ] Fix broken internal links

          #### Medium Priority
          - [ ] Increase test coverage for low-coverage modules
          - [ ] Address TODO/FIXME comments in code
          - [ ] Optimize slow endpoints (if identified)
          - [ ] Update screenshots in documentation

          #### Low Priority
          - [ ] Review and update ROADMAP.md
          - [ ] Review and update TODO-IMPROVEMENTS.md
          - [ ] Improve developer documentation
          - [ ] Add more examples to guides

          ### ü§ñ Copilot Agent Task Prompt

          To delegate work to GitHub Copilot agent, use this prompt:

          \`\`\`
          Review the automated project review report at docs/REVIEW_REPORT.md and address the following:

          1. Fix any failing tests identified in the test results
          2. Address security issues found by bandit scan
          3. Update documentation based on the findings
          4. Add missing tests for modules with low coverage
          5. Clean up TODO/FIXME comments in the codebase

          Create focused PRs for each major issue found. Ensure all changes maintain backward compatibility and don't break existing functionality.
          \`\`\`

          ### üìä Quick Stats

          - **Ref:** \`${REF}\`
          - **Review Date:** $(date -u +\"%Y-%m-%d\")
          - **Workflow Run:** #${RUN_NUMBER}

          ---

          **Auto-generated by:** Manual Project Review & Release Audit workflow"

          # Ensure labels exist before creating issue
          echo "Ensuring issue labels exist..."
          IFS=',' read -ra LABELS <<< "${ISSUE_LABELS}"
          for label in "${LABELS[@]}"; do
            label=$(echo "$label" | xargs) # trim whitespace
            if [ -n "$label" ] && ! gh label list --limit 100 | grep -q "^$label"; then
              echo "Creating label: $label"
              gh label create "$label" --description "Auto-created by workflow" --color "1D76DB" 2>/dev/null || true
            fi
          done
          
          # Try to create issue with labels, fallback to no labels if it fails
          if gh issue create \
            --title "$ISSUE_TITLE" \
            --body "$ISSUE_BODY" \
            --label "${ISSUE_LABELS}" 2>/dev/null; then
            echo "‚úÖ Issue created successfully with labels"
            ISSUE_URL=$(gh issue list --limit 1 --state open --json url --jq '.[0].url')
            echo "ISSUE_URL=$ISSUE_URL" >> $GITHUB_ENV
          elif gh issue create \
            --title "$ISSUE_TITLE" \
            --body "$ISSUE_BODY"; then
            echo "‚úÖ Issue created successfully (without labels)"
            ISSUE_URL=$(gh issue list --limit 1 --state open --json url --jq '.[0].url')
            echo "ISSUE_URL=$ISSUE_URL" >> $GITHUB_ENV
          else
            echo "‚ö†Ô∏è Issue creation failed, but continuing workflow"
          fi
      
      - name: Final Summary
        if: always()
        run: |
          echo "## üéâ Workflow Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The manual project review has completed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${PR_URL:-}" ]; then
            echo "**Pull Request:** ${PR_URL}" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event.inputs.create_pr }}" == "true" ]; then
            if [ "${HAS_CHANGES:-}" == "false" ]; then
              echo "**Pull Request:** ‚ö†Ô∏è Not created (no changes detected)" >> $GITHUB_STEP_SUMMARY
            else
              echo "**Pull Request:** ‚ö†Ô∏è Creation was attempted but may have failed" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          if [ -n "${ISSUE_URL:-}" ]; then
            echo "**Follow-up Issue:** ${ISSUE_URL}" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event.inputs.create_issue }}" == "true" ]; then
            echo "**Follow-up Issue:** ‚ö†Ô∏è Creation was attempted but may have failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Review Report:** Available in artifacts and \`docs/REVIEW_REPORT.md\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Download and review the artifacts" >> $GITHUB_STEP_SUMMARY
          echo "2. Review the PR (if created)" >> $GITHUB_STEP_SUMMARY
          echo "3. Check the follow-up issue (if created)" >> $GITHUB_STEP_SUMMARY
          echo "4. Address high-priority findings" >> $GITHUB_STEP_SUMMARY
