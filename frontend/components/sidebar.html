<!-- ============================================
     Server Monitor v4.0 - Shared Sidebar Component
     Left sidebar navigation with collapsible sections
     ============================================ -->

<style>
  .sidebar-menu {
    padding: var(--space-md) 0;
  }

  .sidebar-section {
    margin-bottom: var(--space-lg);
  }

  .sidebar-section-title {
    padding: var(--space-sm) var(--space-lg);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .sidebar-item {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md) var(--space-lg);
    color: var(--text-primary);
    text-decoration: none;
    transition: all var(--transition-fast);
    cursor: pointer;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    font-size: var(--text-sm);
    position: relative;
  }

  .sidebar-item:hover {
    background-color: var(--bg-tertiary);
  }

  .sidebar-item.active {
    background-color: var(--bg-tertiary);
    border-left: 3px solid var(--accent);
    padding-left: calc(var(--space-lg) - 3px);
    color: var(--accent-light);
  }

  .sidebar-item.active::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    background: linear-gradient(180deg, var(--accent) 0%, var(--accent-dark) 100%);
  }

  .sidebar-item-icon {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .sidebar-item-text {
    flex: 1;
  }

  .sidebar-item-badge {
    font-size: var(--text-xs);
    padding: 2px 6px;
    border-radius: var(--radius-full);
    background-color: var(--accent);
    color: white;
    font-weight: var(--font-semibold);
  }

  .sidebar-divider {
    height: 1px;
    background-color: var(--border-primary);
    margin: var(--space-md) var(--space-lg);
  }

  .sidebar-footer {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: var(--space-lg);
    border-top: 1px solid var(--border-primary);
    background-color: var(--bg-secondary);
  }

  .sidebar-version {
    font-size: var(--text-xs);
    color: var(--text-muted);
    text-align: center;
  }

  /* Collapsed state */
  .app-sidebar.collapsed .sidebar-item-text,
  .app-sidebar.collapsed .sidebar-item-badge,
  .app-sidebar.collapsed .sidebar-section-title,
  .app-sidebar.collapsed .sidebar-footer {
    display: none;
  }

  .app-sidebar.collapsed .sidebar-item {
    justify-content: center;
    padding: var(--space-md);
  }

  @media (max-width: 768px) {
    .app-sidebar {
      transform: translateX(0);
    }

    .app-sidebar.collapsed {
      transform: translateX(-100%);
    }
  }
</style>

<aside class="app-sidebar" id="appSidebar">
  <div class="sidebar-menu">
    <!-- Overview -->
    <div class="sidebar-section">
      <div class="sidebar-section-title" data-i18n="dashboard.overview">Overview</div>

      <a href="/dashboard.html" class="sidebar-item" data-page="dashboard">
        <span class="sidebar-item-icon">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
          </svg>
        </span>
        <span class="sidebar-item-text" data-i18n="dashboard.title">Dashboard</span>
      </a>

    </div>

    <div class="sidebar-divider"></div>

    <!-- Operations -->
    <div class="sidebar-section">
      <div class="sidebar-section-title">Operations</div>

      <a href="/terminal.html" class="sidebar-item" data-page="terminal">
        <span class="sidebar-item-icon">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <polyline points="4 17 10 11 4 5"></polyline>
            <line x1="12" y1="19" x2="20" y2="19"></line>
          </svg>
        </span>
        <span class="sidebar-item-text" data-i18n="terminal.title">Terminal</span>
      </a>

      <a href="#" class="sidebar-item" data-page="server-notes" id="serverNotesLink">
        <span class="sidebar-item-icon">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
          </svg>
        </span>
        <span class="sidebar-item-text" data-i18n="notes.title">Server Notes</span>
      </a>
    </div>

    <div class="sidebar-divider"></div>

    <!-- Configuration Section -->
    <div class="sidebar-section">
      <div class="sidebar-section-title">Configuration</div>

      <a href="/ssh-keys.html" class="sidebar-item" data-page="ssh-keys">
        <span class="sidebar-item-icon">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <path
              d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4">
            </path>
          </svg>
        </span>
        <span class="sidebar-item-text">SSH Keys</span>
      </a>

      <a href="/email-settings.html" class="sidebar-item" data-page="email-settings">
        <span class="sidebar-item-icon">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
            <polyline points="22,6 12,13 2,6"></polyline>
          </svg>
        </span>
        <span class="sidebar-item-text">Email Alerts</span>
      </a>
    </div>

    <div class="sidebar-divider"></div>

    <!-- Administration (Admin Only) -->
    <div class="sidebar-section" id="systemSection" style="display: none;">
      <div class="sidebar-section-title">Administration</div>

      <a href="/users.html" class="sidebar-item" data-page="users" data-role="admin">
        <span class="sidebar-item-icon">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
        </span>
        <span class="sidebar-item-text" data-i18n="users.title">User Management</span>
      </a>

      <a href="/settings.html" class="sidebar-item" data-page="settings" data-role="admin">
        <span class="sidebar-item-icon">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path
              d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24">
            </path>
          </svg>
        </span>
        <span class="sidebar-item-text" data-i18n="settings.title">System Settings</span>
      </a>

      <a href="/domain-settings.html" class="sidebar-item" data-page="domain-settings" data-role="admin">
        <span class="sidebar-item-icon">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <path d="M10 13a8 8 0 0 0 0-16m0 0H3m7 0h7m0 0v7m0-7v-7"></path>
            <path d="M12 11h0"></path>
            <path d="M12 7h0"></path>
          </svg>
        </span>
        <span class="sidebar-item-text" data-i18n="domain.title">Domain & SSL</span>
      </a>

    </div>
  </div>

  <div class="sidebar-footer">
    <div class="sidebar-version">Server Monitor v2.0 Enterprise</div>
  </div>

  <script type="module">
    import api from '/assets/js/api.js';
    import auth from '/assets/js/auth.js';
    import i18n from '/assets/js/i18n.js';

    // Initialize i18n
    async function initI18n() {
      const currentLang = i18n.getCurrentLanguage();
      await i18n.loadLanguage(currentLang);
      translateSidebar();
    }

    // Translate sidebar
    function translateSidebar() {
      document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        element.textContent = i18n.t(key);
      });
    }

    // Initialize sidebar
    async function initSidebar() {
      await initI18n();
      // Set active navigation link
      const currentPage = window.location.pathname.split('/').pop().replace('.html', '') || 'dashboard';
      document.querySelectorAll('.sidebar-item').forEach(link => {
        if (link.getAttribute('data-page') === currentPage) {
          link.classList.add('active');
        }
      });

      // Show/hide menu items based on role
      await applyRoleBasedVisibility();

      // Load server count
      loadServerCount();

      // Handle Server Notes link - make it context-aware
      setupServerNotesLink();
    }

    // Setup Server Notes link to be context-aware
    function setupServerNotesLink() {
      const notesLink = document.getElementById('serverNotesLink');
      if (!notesLink) return;

      // Check if we're on a page with server context
      const urlParams = new URLSearchParams(window.location.search);
      const serverId = urlParams.get('server_id') || urlParams.get('id');

      if (serverId) {
        // Update link with server context
        notesLink.href = `/server-notes.html?server_id=${serverId}`;
      } else {
        // No server context - handle click to show server selection
        notesLink.addEventListener('click', (e) => {
          e.preventDefault();
          alert('Please select a server first to view its notes.\nYou can access notes from the server detail page.');
          // Optionally redirect to dashboard
          window.location.href = '/dashboard.html';
        });
      }
    }

    // Apply role-based visibility
    async function applyRoleBasedVisibility() {
      try {
        const user = auth.getCurrentUser();
        const role = user?.role || 'user';

        // Show system section only for admins
        const systemSection = document.getElementById('systemSection');
        if (systemSection) {
          systemSection.style.display = role === 'admin' ? 'block' : 'none';
        }

        // Hide items that require specific roles
        document.querySelectorAll('.sidebar-item[data-role]').forEach(item => {
          const requiredRole = item.getAttribute('data-role');
          if (requiredRole && role !== requiredRole) {
            item.style.display = 'none';
          }
        });
      } catch (error) {
        console.error('Failed to apply role-based visibility:', error);
      }
    }

    // Load server count for badge
    async function loadServerCount() {
      try {
        const servers = await api.getServers();
        const count = servers?.length || 0;
        const badge = document.getElementById('serverCount');
        if (badge) {
          badge.textContent = count;
          badge.style.display = count > 0 ? 'block' : 'none';
        }
      } catch (error) {
        console.error('Failed to load server count:', error);
      }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSidebar);
    } else {
      initSidebar();
    }

    // Refresh server count periodically
    setInterval(loadServerCount, 30000); // Every 30 seconds
  </script>
</aside>
