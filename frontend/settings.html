<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Settings - Server Monitor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/app.css">
    <link rel="stylesheet" href="assets/css/components.css">
    <style>
        .settings-container {
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 30px;
        }

        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }

        .settings-sidebar {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .settings-nav {
            list-style: none;
        }

        .settings-nav li {
            margin-bottom: 8px;
        }

        .settings-nav a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            color: #94a3b8;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .settings-nav a:hover {
            background: #0f172a;
            color: #e2e8f0;
        }

        .settings-nav a.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .settings-content {
            background: #1e293b;
            border-radius: 12px;
            padding: 30px;
        }

        .settings-section {
            display: none;
        }

        .settings-section.active {
            display: block;
        }

        .section-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #334155;
        }

        .section-header h2 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .section-header p {
            color: #94a3b8;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #cbd5e1;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: #94a3b8;
            font-size: 12px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .settings-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            padding-top: 25px;
            border-top: 1px solid #334155;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #334155;
            color: #e2e8f0;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .info-box {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #93c5fd;
        }

        .info-box i {
            margin-right: 8px;
        }

        .theme-preview {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 10px;
        }

        .theme-option {
            padding: 20px;
            border: 2px solid #334155;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .theme-option:hover {
            border-color: #667eea;
        }

        .theme-option.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .theme-option i {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #334155;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Shared Header & Sidebar -->
        <div id="headerContainer"></div>
        <div id="sidebarContainer"></div>

        <!-- Main Content -->
        <main class="app-main with-sidebar">
    <div class="settings-container">
        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <p>Loading settings...</p>
        </div>

        <!-- Settings Grid -->
        <div id="settingsGrid" class="settings-grid" style="display: none;">
            <!-- Sidebar -->
            <div class="settings-sidebar">
                <ul class="settings-nav">
                    <li>
                        <a href="#general" class="active" onclick="showSection('general')">
                            <i class="fas fa-sliders-h"></i> General
                        </a>
                    </li>
                    <li>
                        <a href="#localization" onclick="showSection('localization')">
                            <i class="fas fa-globe"></i> Localization
                        </a>
                    </li>
                    <li>
                        <a href="#appearance" onclick="showSection('appearance')">
                            <i class="fas fa-palette"></i> Appearance
                        </a>
                    </li>
                    <li>
                        <a href="#security" onclick="showSection('security')">
                            <i class="fas fa-shield-alt"></i> Security
                        </a>
                    </li>
                    <li>
                        <a href="#notifications" onclick="showSection('notifications')">
                            <i class="fas fa-bell"></i> Notifications
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Content -->
            <div class="settings-content">
                <!-- General Section -->
                <div id="general-section" class="settings-section active">
                    <div class="section-header">
                        <h2>General Settings</h2>
                        <p>Basic system configuration</p>
                    </div>

                    <div class="form-group">
                        <label>Session Timeout (hours)</label>
                        <input type="number" id="session_timeout" min="1" max="720" value="24">
                        <small>How long users stay logged in (1-720 hours)</small>
                    </div>

                    <div class="form-group">
                        <label>Items Per Page</label>
                        <select id="items_per_page">
                            <option value="10">10 items</option>
                            <option value="20" selected>20 items</option>
                            <option value="50">50 items</option>
                            <option value="100">100 items</option>
                        </select>
                        <small>Number of items to display in lists</small>
                    </div>

                    <div class="settings-actions">
                        <button class="btn btn-secondary" onclick="loadSettings()">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                        <button class="btn btn-primary" onclick="saveGeneralSettings()">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </div>

                <!-- Localization Section -->
                <div id="localization-section" class="settings-section">
                    <div class="section-header">
                        <h2>Localization Settings</h2>
                        <p>Configure timezone, language, and regional formats</p>
                    </div>

                    <div class="form-group">
                        <label>Timezone</label>
                        <select id="timezone">
                            <!-- Options will be loaded dynamically -->
                        </select>
                        <small>System timezone for dates and times</small>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Date Format</label>
                            <select id="date_format">
                                <option value="YYYY-MM-DD">YYYY-MM-DD (2026-01-06)</option>
                                <option value="DD/MM/YYYY">DD/MM/YYYY (06/01/2026)</option>
                                <option value="MM/DD/YYYY">MM/DD/YYYY (01/06/2026)</option>
                                <option value="DD.MM.YYYY">DD.MM.YYYY (06.01.2026)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Time Format</label>
                            <select id="time_format">
                                <option value="24h">24 Hour (23:59)</option>
                                <option value="12h">12 Hour (11:59 PM)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Language</label>
                        <select id="language">
                            <option value="en">English</option>
                            <option value="vi">Tiếng Việt</option>
                            <option value="zh-CN">简体中文</option>
                            <option value="ja">日本語</option>
                            <option value="ko">한국어</option>
                            <option value="es">Español</option>
                            <option value="fr">Français</option>
                            <option value="de">Deutsch</option>
                        </select>
                        <small>User interface language</small>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Number Format</label>
                            <select id="number_format">
                                <option value="en-US">1,234.56 (English)</option>
                                <option value="de-DE">1.234,56 (German)</option>
                                <option value="fr-FR">1 234,56 (French)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Currency</label>
                            <select id="currency">
                                <option value="USD">USD ($)</option>
                                <option value="EUR">EUR (€)</option>
                                <option value="GBP">GBP (£)</option>
                                <option value="JPY">JPY (¥)</option>
                                <option value="VND">VND (₫)</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-actions">
                        <button class="btn btn-secondary" onclick="loadSettings()">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                        <button class="btn btn-primary" onclick="saveLocalizationSettings()">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </div>

                <!-- Appearance Section -->
                <div id="appearance-section" class="settings-section">
                    <div class="section-header">
                        <h2>Appearance Settings</h2>
                        <p>Customize the look and feel</p>
                    </div>

                    <div class="form-group">
                        <label>Theme</label>
                        <div class="theme-preview">
                            <div class="theme-option" data-theme="light">
                                <i class="fas fa-sun" style="color: #f59e0b;"></i>
                                <div>Light</div>
                            </div>
                            <div class="theme-option selected" data-theme="dark">
                                <i class="fas fa-moon" style="color: #667eea;"></i>
                                <div>Dark</div>
                            </div>
                            <div class="theme-option" data-theme="auto">
                                <i class="fas fa-adjust" style="color: #94a3b8;"></i>
                                <div>Auto</div>
                            </div>
                        </div>
                        <input type="hidden" id="theme" value="dark">
                    </div>

                    <div class="info-box">
                        <i class="fas fa-info-circle"></i>
                        Theme preferences will be applied system-wide for all users. Auto theme follows system
                        preferences.
                    </div>

                    <div class="settings-actions">
                        <button class="btn btn-secondary" onclick="loadSettings()">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                        <button class="btn btn-primary" onclick="saveAppearanceSettings()">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </div>

                <!-- Security Section -->
                <div id="security-section" class="settings-section">
                    <div class="section-header">
                        <h2>Security Settings</h2>
                        <p>Configure security and authentication</p>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enable_2fa" style="width: auto; margin-right: 8px;">
                            Enable Two-Factor Authentication (2FA)
                        </label>
                        <small>Require 2FA for all user accounts</small>
                    </div>

                    <div class="info-box">
                        <i class="fas fa-info-circle"></i>
                        When enabled, users will need to set up 2FA on their next login.
                    </div>

                    <div class="settings-actions">
                        <button class="btn btn-secondary" onclick="loadSettings()">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                        <button class="btn btn-primary" onclick="saveSecuritySettings()">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </div>

                <!-- Notifications Section -->
                <div id="notifications-section" class="settings-section">
                    <div class="section-header">
                        <h2>Notification Settings</h2>
                        <p>Configure notification channels</p>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="smtp_enabled" style="width: auto; margin-right: 8px;">
                            Enable Email Notifications
                        </label>
                        <small>Send alerts via email (configure in Email Settings)</small>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="telegram_enabled" style="width: auto; margin-right: 8px;">
                            Enable Telegram Notifications
                        </label>
                        <small>Send alerts via Telegram bot</small>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="slack_enabled" style="width: auto; margin-right: 8px;">
                            Enable Slack Notifications
                        </label>
                        <small>Send alerts via Slack webhooks</small>
                    </div>

                    <div class="info-box">
                        <i class="fas fa-info-circle"></i>
                        These are global notification settings. Configure channel-specific settings in their respective
                        configuration pages.
                    </div>

                    <div class="settings-actions">
                        <button class="btn btn-secondary" onclick="loadSettings()">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                        <button class="btn btn-primary" onclick="saveNotificationSettings()">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
        </main>
    </div>

    <script type="module">
        import api from '/assets/js/api.js';
        import auth from '/assets/js/auth.js';
        import i18n from '/assets/js/i18n.js';
        import { loadHeaderAndSidebar } from '/assets/js/component-loader.js';

        const API_BASE_URL = window.API_BASE_URL || `http://${window.location.hostname}:9083`;
        let currentSettings = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            (async () => {
                await loadHeaderAndSidebar();
                const currentLang = i18n.getCurrentLanguage();
                await i18n.loadLanguage(currentLang);
                document.documentElement.lang = currentLang;
                i18n.translatePage();
                await loadSettings();
            })();

            // Theme selection
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', function () {
                    document.querySelectorAll('.theme-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    document.getElementById('theme').value = this.dataset.theme;
                });
            });
        });

        function checkAuth() {
            const user = auth.getCurrentUser();
            if (!user) {
                window.location.href = '/login.html';
                return;
            }
            if (user.role !== 'admin') {
                showAlert('Access denied. Admin access required.', 'error');
                setTimeout(() => window.location.href = '/dashboard.html', 2000);
                return;
            }
        }

        async function loadSettings() {
            try {
                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('settingsGrid').style.display = 'none';

                // Load settings
                const response = await fetch(`${API_BASE_URL}/api/settings`, {
                    headers: {
                        'Authorization': `Bearer ${auth.getToken()}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load settings');
                }

                currentSettings = await response.json();

                // Load timezone options
                const optionsResponse = await fetch(`${API_BASE_URL}/api/settings/options`);
                const options = await optionsResponse.json();

                const timezoneSelect = document.getElementById('timezone');
                timezoneSelect.innerHTML = '';
                options.timezones.forEach(tz => {
                    const option = document.createElement('option');
                    option.value = tz;
                    option.textContent = tz;
                    timezoneSelect.appendChild(option);
                });

                // Populate form fields
                populateFormFields(currentSettings);

                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('settingsGrid').style.display = 'grid';

            } catch (error) {
                console.error('Error loading settings:', error);
                showAlert('Failed to load settings: ' + error.message, 'error');
                document.getElementById('loadingState').style.display = 'none';
            }
        }

        function populateFormFields(settings) {
            // General
            document.getElementById('session_timeout').value = settings.session_timeout || 24;
            document.getElementById('items_per_page').value = settings.items_per_page || 20;

            // Localization
            document.getElementById('timezone').value = settings.timezone || 'UTC';
            document.getElementById('date_format').value = settings.date_format || 'YYYY-MM-DD';
            document.getElementById('time_format').value = settings.time_format || '24h';
            document.getElementById('language').value = settings.language || 'en';
            document.getElementById('number_format').value = settings.number_format || 'en-US';
            document.getElementById('currency').value = settings.currency || 'USD';

            // Appearance
            const theme = settings.theme || 'dark';
            document.getElementById('theme').value = theme;
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.toggle('selected', option.dataset.theme === theme);
            });

            // Security
            document.getElementById('enable_2fa').checked = settings.enable_2fa || false;

            // Notifications
            document.getElementById('smtp_enabled').checked = settings.smtp_enabled || false;
            document.getElementById('telegram_enabled').checked = settings.telegram_enabled || false;
            document.getElementById('slack_enabled').checked = settings.slack_enabled || false;
        }

        function showSection(section) {
            // Update nav
            document.querySelectorAll('.settings-nav a').forEach(link => {
                link.classList.remove('active');
            });
            event.target.closest('a').classList.add('active');

            // Update content
            document.querySelectorAll('.settings-section').forEach(sec => {
                sec.classList.remove('active');
            });
            document.getElementById(section + '-section').classList.add('active');
        }

        async function saveGeneralSettings() {
            const settings = {
                session_timeout: parseInt(document.getElementById('session_timeout').value),
                items_per_page: parseInt(document.getElementById('items_per_page').value)
            };

            await saveSettings(settings, 'General settings saved successfully');
        }

        async function saveLocalizationSettings() {
            const settings = {
                timezone: document.getElementById('timezone').value,
                date_format: document.getElementById('date_format').value,
                time_format: document.getElementById('time_format').value,
                language: document.getElementById('language').value,
                number_format: document.getElementById('number_format').value,
                currency: document.getElementById('currency').value
            };

            await saveSettings(settings, 'Localization settings saved successfully');
        }

        async function saveAppearanceSettings() {
            const settings = {
                theme: document.getElementById('theme').value
            };

            await saveSettings(settings, 'Appearance settings saved successfully');
        }

        async function saveSecuritySettings() {
            const settings = {
                enable_2fa: document.getElementById('enable_2fa').checked
            };

            await saveSettings(settings, 'Security settings saved successfully');
        }

        async function saveNotificationSettings() {
            const settings = {
                smtp_enabled: document.getElementById('smtp_enabled').checked,
                telegram_enabled: document.getElementById('telegram_enabled').checked,
                slack_enabled: document.getElementById('slack_enabled').checked
            };

            await saveSettings(settings, 'Notification settings saved successfully');
        }

        async function saveSettings(settings, successMessage) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify(settings)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showAlert(successMessage, 'success');
                    // Reload settings to reflect changes
                    setTimeout(() => loadSettings(), 1000);
                } else {
                    showAlert(result.error || 'Failed to save settings', 'error');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showAlert('Failed to save settings: ' + error.message, 'error');
            }
        }

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            container.appendChild(alert);

            setTimeout(() => {
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 300);
            }, 5000);
        }

        // Backward-compat helpers (if any legacy calls remain)
        function getCurrentUser() { return auth.getCurrentUser(); }
        function getToken() { return auth.getToken(); }
    </script>
</body>

</html>
