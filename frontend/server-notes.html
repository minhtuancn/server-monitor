<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="notes.title">Server Notes</title>
    <link rel="stylesheet" href="assets/css/themes.css">
    <link rel="stylesheet" href="assets/css/components.css">
    <link rel="stylesheet" href="assets/css/app.css">
    <!-- SimpleMDE Markdown Editor -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .notes-container {
            padding: 20px;
        }

        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .notes-list {
            display: grid;
            gap: 15px;
        }

        .note-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .note-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .note-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .note-preview {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .note-meta {
            font-size: 0.8em;
            color: var(--text-muted);
            display: flex;
            gap: 15px;
        }

        .note-editor-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .note-editor-modal.active {
            display: flex;
        }

        .note-editor-content {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 25px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .note-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .note-form-group {
            margin-bottom: 15px;
        }

        .note-form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .note-form-group input,
        .note-form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .note-form-group textarea {
            min-height: 200px;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .note-editor-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        /* SimpleMDE customization */
        .CodeMirror,
        .CodeMirror-scroll {
            min-height: 300px;
        }
        .editor-toolbar {
            border-color: var(--border-color);
            background: var(--card-bg);
        }
        .editor-toolbar button {
            color: var(--text-primary) !important;
        }
        .editor-toolbar button:hover {
            background: var(--hover-bg);
            border-color: var(--primary-color);
        }
        .CodeMirror {
            border-color: var(--border-color);
            background: var(--input-bg);
            color: var(--text-primary);
        }
    </style>
</head>

<body>
    <div id="headerContainer"></div>
    <div id="sidebarContainer"></div>

    <div class="app-main with-sidebar">
        <div class="notes-container">
            <div class="notes-header">
                <div>
                    <h2 data-i18n="notes.title">Server Notes</h2>
                    <p data-i18n="notes.subtitle">Manage Markdown documentation for this server</p>
                </div>
                <button class="btn btn-primary" id="addNoteBtn">
                    <i class="fas fa-plus"></i>
                    <span data-i18n="notes.add_note">Add Note</span>
                </button>
            </div>

            <div id="notesListContainer">
                <div class="loading">Loading notes...</div>
            </div>
        </div>
    </div>

    <!-- Note Editor Modal -->
    <div id="noteEditorModal" class="note-editor-modal">
        <div class="note-editor-content">
            <div class="note-editor-header">
                <h3 id="modalTitle" data-i18n="notes.add_note">Add Note</h3>
                <button class="btn btn-text" id="closeModalBtn">&times;</button>
            </div>
            <form id="noteForm">
                <input type="hidden" id="noteId" value="">
                <div class="note-form-group">
                    <label for="noteTitle" data-i18n="notes.title_label">Title</label>
                    <input type="text" id="noteTitle" required data-i18n-placeholder="notes.title_placeholder">
                </div>
                <div class="note-form-group">
                    <label for="noteContent" data-i18n="notes.content_label">Content (Markdown)</label>
                    <textarea id="noteContent" data-i18n-placeholder="notes.content_placeholder"></textarea>
                </div>
                <div class="note-editor-actions">
                    <button type="button" class="btn btn-secondary" id="cancelBtn"
                        data-i18n="notes.cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" data-i18n="notes.save">Save Note</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { auth } from './assets/js/auth.js';
        import { i18n } from './assets/js/utils.js';
        import { loadComponents } from './assets/js/utils.js';

        let currentServerId = null;
        let currentNoteId = null;
        let simplemde = null;

        // Get server ID from URL query string
        const urlParams = new URLSearchParams(window.location.search);
        currentServerId = urlParams.get('server_id');

        if (!currentServerId) {
            alert('No server specified');
            window.location.href = 'dashboard.html';
        }

        // Check authentication
        auth.requireAuth();

        // Initialize
        async function init() {
            await loadComponents();
            await i18n.init();
            initializeMarkdownEditor();
            await fetchNotes();
            setupEventListeners();
        }

        function initializeMarkdownEditor() {
            // Configure Marked.js
            marked.setOptions({
                breaks: true,
                gfm: true,
                headerIds: false,
                mangle: false
            });

            simplemde = new SimpleMDE({
                element: document.getElementById('noteContent'),
                spellChecker: false,
                placeholder: i18n.t('notes.content_placeholder') || 'Enter note content in Markdown format...',
                toolbar: [
                    'bold', 'italic', 'heading', '|',
                    'quote', 'unordered-list', 'ordered-list', '|',
                    'link', 'image', 'code', 'table', '|',
                    'preview', 'side-by-side', 'fullscreen', '|',
                    'guide'
                ],
                previewRender: function(plainText) {
                    return marked.parse(plainText);
                },
                renderingConfig: {
                    singleLineBreaks: false,
                    codeSyntaxHighlighting: true
                }
            });
        }

        function setupEventListeners() {
            document.getElementById('addNoteBtn').addEventListener('click', () => {
                openNoteEditor();
            });

            document.getElementById('closeModalBtn').addEventListener('click', closeNoteEditor);
            document.getElementById('cancelBtn').addEventListener('click', closeNoteEditor);

            document.getElementById('noteForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveNote();
            });
        }

        async function fetchNotes() {
            try {
                const token = auth.getToken();
                const response = await fetch(`/api/servers/${currentServerId}/notes`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch notes');
                }

                const data = await response.json();
                renderNotes(data.notes || []);
            } catch (error) {
                console.error('Error fetching notes:', error);
                document.getElementById('notesListContainer').innerHTML = `
                    <div class="alert alert-error">
                        ${i18n.t('notes.load_failed') || 'Failed to load notes'}
                    </div>
                `;
            }
        }

        function renderNotes(notes) {
            const container = document.getElementById('notesListContainer');

            if (!notes.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-sticky-note"></i>
                        <p data-i18n="notes.empty">${i18n.t('notes.empty') || 'No notes yet. Click "Add Note" to create one.'}</p>
                    </div>
                `;
                return;
            }

            const notesHTML = notes.map(note => {
                // Render Markdown preview using Marked.js (sanitized)
                const rawPreview = note.content.substring(0, 200);
                const htmlPreview = marked.parse(rawPreview);
                // Strip HTML tags for plain text preview in card
                const textPreview = htmlPreview.replace(/<[^>]*>/g, '').substring(0, 150);
                
                const created = new Date(note.created_at).toLocaleDateString();
                const updated = new Date(note.updated_at).toLocaleDateString();

                return `
                    <div class="note-card" data-note-id="${note.id}">
                        <div class="note-title">${escapeHtml(note.title)}</div>
                        <div class="note-preview">${escapeHtml(textPreview)}...</div>
                        <div class="note-meta">
                            <span>${i18n.t('notes.created') || 'Created'}: ${created}</span>
                            <span>${i18n.t('notes.updated') || 'Updated'}: ${updated}</span>
                            <span>${i18n.t('notes.by') || 'By'}: ${escapeHtml(note.created_by || 'admin')}</span>
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-sm btn-secondary edit-note-btn" data-note-id="${note.id}">
                                <i class="fas fa-edit"></i> ${i18n.t('notes.edit') || 'Edit'}
                            </button>
                            <button class="btn btn-sm btn-danger delete-note-btn" data-note-id="${note.id}">
                                <i class="fas fa-trash"></i> ${i18n.t('notes.delete') || 'Delete'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="notes-list">${notesHTML}</div>`;

            // Attach event listeners
            container.querySelectorAll('.edit-note-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const noteId = btn.dataset.noteId;
                    const note = notes.find(n => n.id == noteId);
                    if (note) openNoteEditor(note);
                });
            });

            container.querySelectorAll('.delete-note-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const noteId = btn.dataset.noteId;
                    if (confirm(i18n.t('notes.delete_confirm') || 'Are you sure you want to delete this note?')) {
                        await deleteNote(noteId);
                    }
                });
            });
        }

        function openNoteEditor(note = null) {
            const modal = document.getElementById('noteEditorModal');
            const form = document.getElementById('noteForm');
            const modalTitle = document.getElementById('modalTitle');

            if (note) {
                // Edit mode
                currentNoteId = note.id;
                document.getElementById('noteId').value = note.id;
                document.getElementById('noteTitle').value = note.title;
                simplemde.value(note.content || '');
                modalTitle.textContent = i18n.t('notes.edit_note') || 'Edit Note';
            } else {
                // Create mode
                currentNoteId = null;
                form.reset();
                simplemde.value('');
                modalTitle.textContent = i18n.t('notes.add_note') || 'Add Note';
            }

            modal.classList.add('active');
        }

        function closeNoteEditor() {
            document.getElementById('noteEditorModal').classList.remove('active');
            currentNoteId = null;
        }

        async function saveNote() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = simplemde.value().trim();

            if (!title) {
                alert(i18n.t('notes.title_required') || 'Title is required');
                return;
            }

            try {
                const token = auth.getToken();
                const user = auth.getCurrentUser();
                const url = currentNoteId
                    ? `/api/servers/${currentServerId}/notes/${currentNoteId}`
                    : `/api/servers/${currentServerId}/notes`;

                const method = currentNoteId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        title: title,
                        content: content,
                        created_by: user.username
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to save note');
                }

                closeNoteEditor();
                await fetchNotes();

                alert(i18n.t('notes.save_success') || 'Note saved successfully');
            } catch (error) {
                console.error('Error saving note:', error);
                alert(i18n.t('notes.save_failed') || 'Failed to save note');
            }
        }

        async function deleteNote(noteId) {
            try {
                const token = auth.getToken();
                const response = await fetch(`/api/servers/${currentServerId}/notes/${noteId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to delete note');
                }

                await fetchNotes();
                alert(i18n.t('notes.delete_success') || 'Note deleted successfully');
            } catch (error) {
                console.error('Error deleting note:', error);
                alert(i18n.t('notes.delete_failed') || 'Failed to delete note');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        init();
    </script>
</body>

</html>
