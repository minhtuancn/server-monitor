<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSH Keys - Server Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/assets/vendor/fontawesome/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc', 400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e' },
                        dark: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a', 950: '#020617' }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    </style>
</head>
<body class="bg-dark-950 text-gray-100 dark min-h-screen">
    <div id="sidebarContainer"></div>
    <div class="ml-64">
        <div id="headerContainer"></div>
        <main class="p-6 custom-scrollbar" style="height: calc(100vh - 64px); overflow-y: auto;">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-white">SSH Keys Management</h2>
                    <p class="text-gray-400 mt-1">Manage SSH keys for secure server connections</p>
                </div>
                <button onclick="openModal('addKeyModal')" class="px-4 py-2.5 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-medium flex items-center gap-2">
                    <i class="fas fa-plus"></i><span>Add SSH Key</span>
                </button>
            </div>
            <div class="grid gap-4" id="sshKeysContainer">
                <div class="flex items-center justify-center py-12"><i class="fas fa-spinner fa-spin text-3xl text-primary-500"></i></div>
            </div>
        </main>
    </div>
    <div id="addKeyModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-dark-800 rounded-xl shadow-2xl w-full max-w-lg m-4 border border-dark-700">
            <div class="flex items-center justify-between p-4 border-b border-dark-700">
                <h3 class="text-lg font-semibold text-white">Add SSH Key</h3>
                <button onclick="closeModal('addKeyModal')" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <form id="addKeyForm" class="p-4 space-y-4">
                <div><label class="block text-sm font-medium text-gray-300 mb-1">Key Name</label><input type="text" name="name" required class="w-full px-4 py-2.5 bg-dark-900 border border-dark-600 rounded-lg text-white focus:ring-2 focus:ring-primary-500" placeholder="e.g., Production Server Key"></div>
                <div><label class="block text-sm font-medium text-gray-300 mb-1">Username</label><input type="text" name="username" required class="w-full px-4 py-2.5 bg-dark-900 border border-dark-600 rounded-lg text-white focus:ring-2 focus:ring-primary-500" placeholder="e.g., root"></div>
                <div><label class="block text-sm font-medium text-gray-300 mb-1">Private Key</label><textarea name="private_key" rows="6" required class="w-full px-4 py-2.5 bg-dark-900 border border-dark-600 rounded-lg text-white font-mono text-sm focus:ring-2 focus:ring-primary-500" placeholder="-----BEGIN RSA PRIVATE KEY-----"></textarea></div>
                <div><label class="block text-sm font-medium text-gray-300 mb-1">Key Passphrase (optional)</label><input type="password" name="passphrase" class="w-full px-4 py-2.5 bg-dark-900 border border-dark-600 rounded-lg text-white focus:ring-2 focus:ring-primary-500" placeholder="Enter passphrase if encrypted"></div>
                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" onclick="closeModal('addKeyModal')" class="px-4 py-2.5 bg-dark-700 hover:bg-dark-600 text-white rounded-lg font-medium">Cancel</button>
                    <button type="submit" class="px-4 py-2.5 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-medium">Add Key</button>
                </div>
            </form>
        </div>
    </div>
    <div id="deleteModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-dark-800 rounded-xl shadow-2xl w-full max-w-md m-4 border border-dark-700">
            <div class="p-6 text-center">
                <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-trash-alt text-red-400 text-2xl"></i></div>
                <h3 class="text-xl font-semibold text-white mb-2">Delete SSH Key?</h3>
                <p class="text-gray-400 mb-6">This action cannot be undone.</p>
                <input type="hidden" id="deleteKeyId">
                <div class="flex justify-center gap-3">
                    <button onclick="closeModal('deleteModal')" class="px-4 py-2.5 bg-dark-700 hover:bg-dark-600 text-white rounded-lg font-medium">Cancel</button>
                    <button onclick="confirmDelete()" class="px-4 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium">Delete</button>
                </div>
            </div>
        </div>
    </div>
    <script src="assets/js/layout.js"></script>
    <script>
        initLayout('SSH Keys');
        const currentPort = window.location.port || '80';
        const apiPort = currentPort === '9081' ? 9083 : 8083;
        const API_BASE = location.protocol + '//' + location.hostname + ':' + apiPort;
        const authToken = localStorage.getItem('auth_token');

        async function loadSSHKeys() {
            try {
                const response = await fetch(API_BASE + '/api/ssh-keys', { headers: { 'Authorization': 'Bearer ' + authToken } });
                if (!response.ok) throw new Error('Failed');
                renderSSHKeys(await response.json());
            } catch (e) {
                document.getElementById('sshKeysContainer').innerHTML = '<div class="text-center py-12"><p class="text-gray-400">Failed to load SSH keys</p></div>';
            }
        }

        function renderSSHKeys(keys) {
            const container = document.getElementById('sshKeysContainer');
            if (!keys || keys.length === 0) {
                container.innerHTML = '<div class="text-center py-12 bg-dark-800 rounded-xl border border-dark-700"><div class="w-16 h-16 bg-dark-700 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-key text-gray-500 text-2xl"></i></div><h3 class="text-lg font-medium text-white mb-2">No SSH Keys</h3><p class="text-gray-400 mb-4">Add your first SSH key to connect securely.</p><button onclick="openModal(\'addKeyModal\')" class="px-4 py-2.5 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-medium"><i class="fas fa-plus mr-2"></i>Add SSH Key</button></div>';
                return;
            }
            container.innerHTML = keys.map(key => '<div class="bg-dark-800 border border-dark-700 rounded-xl p-4 hover:border-dark-600"><div class="flex items-center justify-between"><div class="flex items-center gap-4"><div class="w-12 h-12 bg-primary-500/20 rounded-lg flex items-center justify-center"><i class="fas fa-key text-primary-400 text-xl"></i></div><div><h3 class="font-semibold text-white">' + escapeHtml(key.name) + '</h3><div class="flex items-center gap-4 mt-1 text-sm text-gray-400"><span><i class="fas fa-user mr-1"></i>' + escapeHtml(key.username) + '</span></div></div></div><div class="flex items-center gap-2"><button onclick="deleteKey(' + key.id + ')" class="p-2 text-gray-400 hover:text-red-400 hover:bg-dark-700 rounded-lg"><i class="fas fa-trash-alt"></i></button></div></div></div>').join('');
        }

        function escapeHtml(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function deleteKey(id) { document.getElementById('deleteKeyId').value = id; openModal('deleteModal'); }

        async function confirmDelete() {
            const id = document.getElementById('deleteKeyId').value;
            try {
                const r = await fetch(API_BASE + '/api/ssh-keys/' + id, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + authToken } });
                if (!r.ok) throw new Error('Failed');
                showToast('SSH key deleted', 'success'); closeModal('deleteModal'); loadSSHKeys();
            } catch (e) { showToast('Failed to delete', 'error'); }
        }

        document.getElementById('addKeyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target));
            try {
                const r = await fetch(API_BASE + '/api/ssh-keys', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken }, body: JSON.stringify(data) });
                if (!r.ok) throw new Error((await r.json()).error || 'Failed');
                showToast('SSH key added', 'success'); closeModal('addKeyModal'); e.target.reset(); loadSSHKeys();
            } catch (e) { showToast('Failed: ' + e.message, 'error'); }
        });

        loadSSHKeys();
    </script>
</body>
</html>
